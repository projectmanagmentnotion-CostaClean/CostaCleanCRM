<!-- =========================
ARCHIVO: scripts.html
Lógica UI (mock) + router de acciones + listas + detalle
========================= -->
<script>
  /**************
   * DEBUG SAFE LOG
   **************/
  function safeLog_(label, obj){
    try {
      if (typeof console !== 'undefined' && console && console.log) console.log('[CC]', label, obj);
    } catch(_){}
  }
  function safeLog(label, obj){ return safeLog_(label, obj); }
/* =========================
   Helpers DOM
========================= */
const qs  = (sel, root=document) => root.querySelector(sel);
const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));

/* =========================
   Estado UI
========================= */
const state = {
  useMock: false,
  currentEntity: 'clientes',        // entidad activa en listas
  listFilterClientId: null,         // filtro por cliente (historial)
  detail: { entity:null, id:null, clientId:null },
  lastScreen: 'screen-home'
};

const STORAGE_KEYS = {
  useMock: 'cc_use_mock',
  legacyUseMock: 'cc_useMock'
};

const store = {
  presupuestos: [],
  presDetalle: {},
  clientes: [],
  leads: []
};

/* =========================
   Mock: LISTAS
   (Asegúrate de que los IDs coincidan con tus capturas)
========================= */
const MOCK = {
  clientes: [
    { id:'CLI-2025-0007', title:'Marta R.', sub:'NIF: X1234567A · Barcelona', right:'Activo',
      email:'marta@email.com', phone:'+34 600 123 123', city:'Barcelona', status:'Activo' },
    { id:'CLI-2025-0008', title:'Comunidad Pineda', sub:'NIF: B66778899 · Pineda de Mar', right:'Lead',
      email:'admin@pineda.com', phone:'+34 611 222 333', city:'Pineda de Mar', status:'Lead' }
  ],
  leads: [
    { id:'L0009', title:'Comunidad Pineda (Lead)', sub:'Email: admin@pineda.com · Pineda de Mar', right:'Nuevo',
      email:'admin@pineda.com', phone:'+34 611 222 333', city:'Pineda de Mar', status:'Nuevo' }
  ],
  facturas: [
    { id:'F-2025-0123', title:'Factura F-2025-0123', sub:'CLI-2025-0007 · Pendiente', right:'120 €',
      clientId:'CLI-2025-0007', status:'Pendiente', amount:120 },
    { id:'F-2025-0124', title:'Factura F-2025-0124', sub:'CLI-2025-0008 · Pagada', right:'240 €',
      clientId:'CLI-2025-0008', status:'Pagada', amount:240 }
  ],
  proformas: [
    { id:'PRO-2025-0009', title:'Proforma PRO-2025-0009', sub:'CLI-2025-0007 · Enviada', right:'290,40 €',
      clientId:'CLI-2025-0007', status:'Enviada', amount:290.40 }
  ],
  gastos: [
    { id:'G-2025-0042', title:'Gasto G-2025-0042', sub:'Operación · Gasolina', right:'48,00 €',
      clientId:'CLI-2025-0007', status:'Ok', amount:48.00 }
  ]
};

/* =========================
   Mock: DETALLE
   (Si no existe aquí, mostramos fallback)
========================= */
const MOCK_DETAIL = {
  clientes: {
    'CLI-2025-0007': {
      id:'CLI-2025-0007',
      title:'Marta R.',
      sub:'NIF: X1234567A · Barcelona',
      status:'Activo',
      email:'marta@email.com',
      phone:'+34 600 123 123',
      address:'Barcelona'
    },
    'CLI-2025-0008': {
      id:'CLI-2025-0008',
      title:'Comunidad Pineda',
      sub:'NIF: B66778899 · Pineda de Mar',
      status:'Lead',
      email:'admin@pineda.com',
      phone:'+34 611 222 333',
      address:'Pineda de Mar'
    }
  },
  leads: {
    'L0009': {
      id:'L0009',
      title:'Comunidad Pineda (Lead)',
      sub:'Email: admin@pineda.com · Pineda de Mar',
      status:'Nuevo',
      email:'admin@pineda.com',
      phone:'+34 611 222 333',
      address:'Pineda de Mar'
    }
  },
  facturas: {
    'F-2025-0123': {
      id:'F-2025-0123',
      title:'Factura F-2025-0123',
      sub:'CLI-2025-0007 · Pendiente',
      status:'Pendiente',
      amount:120,
      clientId:'CLI-2025-0007'
    },
    'F-2025-0124': {
      id:'F-2025-0124',
      title:'Factura F-2025-0124',
      sub:'CLI-2025-0008 · Pagada',
      status:'Pagada',
      amount:240,
      clientId:'CLI-2025-0008'
    }
  },
  proformas: {
    'PRO-2025-0009': {
      id:'PRO-2025-0009',
      title:'Proforma PRO-2025-0009',
      sub:'CLI-2025-0007 · Enviada',
      status:'Enviada',
      amount:290.40,
      clientId:'CLI-2025-0007'
    }
  },
  gastos: {
    'G-2025-0042': {
      id:'G-2025-0042',
      title:'Gasto G-2025-0042',
      sub:'Operación · Gasolina',
      status:'Ok',
      amount:48.00,
      clientId:'CLI-2025-0007'
    }
  }
};

/* =========================
   UI: Toasts
========================= */
function toast(title, msg, tone='ok'){
  const host = qs('.cc-toasts');
  if (!host) return;

  const el = document.createElement('div');
  el.className = `cc-toast cc-toast--${tone}`;
  el.innerHTML = `
    <div class="cc-toastTitle">${escapeHtml(title)}</div>
    <div class="cc-toastMsg">${escapeHtml(msg)}</div>
  `;
  host.appendChild(el);

  setTimeout(() => el.classList.add('is-in'), 10);
  setTimeout(() => {
    el.classList.remove('is-in');
    setTimeout(() => el.remove(), 200);
  }, 2500);
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function loadMockPreference_(){
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.useMock);
    if (saved !== null) {
      state.useMock = saved === 'true';
      return;
    }
    const legacy = localStorage.getItem(STORAGE_KEYS.legacyUseMock);
    if (legacy !== null) {
      state.useMock = legacy === 'true';
      localStorage.setItem(STORAGE_KEYS.useMock, String(state.useMock));
      localStorage.removeItem(STORAGE_KEYS.legacyUseMock);
    }
  } catch (_) {}
    // Override por URL: ?mock=1 o ?mock=0 (prioridad máxima)
    try {
      const params = new URLSearchParams(location.search);
      const q = params.get('mock');
      if (q === '1' || q === 'true') {
        state.useMock = true;
        localStorage.setItem(STORAGE_KEYS.useMock, 'true');
      }
      if (q === '0' || q === 'false') {
        state.useMock = false;
        localStorage.setItem(STORAGE_KEYS.useMock, 'false');
      }
    } catch(err) {}

}
function applyMockFromUrl_(){
  try{
    const sp = new URLSearchParams(location.search);
    if (!sp.has('mock')) return;
    const v = String(sp.get('mock')).trim().toLowerCase();
    if (v === '0' || v === 'false') state.useMock = false;
    if (v === '1' || v === 'true')  state.useMock = true;
    saveMockPreference_();
  }catch(_){}
}


function saveMockPreference_(){
  try {
    localStorage.setItem(STORAGE_KEYS.useMock, String(state.useMock));
  } catch (_) {}
}

function updateMockChip_(){
  const chip = qs('[data-action="toggle_mock"]');
  if(!chip) return;
  chip.classList.toggle('cc-chip--ok', !!state.useMock);
  chip.setAttribute('aria-pressed', state.useMock ? 'true' : 'false');
  chip.textContent = state.useMock ? 'Mock data' : 'Real data';
}

function callServer(fnName, ...args){
  return new Promise((resolve, reject) => {
    try{
      const runner = (typeof google !== 'undefined' && google.script && google.script.run)
        ? google.script.run
        : null;

      if (!runner){
        reject(new Error('API no disponible (google.script.run)'));
        return;
      }

      const call = runner
        .withSuccessHandler((res) => resolve(res))
        .withFailureHandler((err) => {
          const msg = (err && err.message) ? err.message : String(err);
          reject(new Error(msg));
        });

      if (typeof call[fnName] !== 'function'){
        reject(new Error('Función server no encontrada: ' + fnName));
        return;
      }

      call[fnName](...args);
    } catch(ex){
      reject(ex);
    }
  });
}

/* =========================
   Navegación a listas
========================= */
function goToList(entity, filterClientId){
  state.currentEntity = entity;
  state.listFilterClientId = filterClientId || null;

  // UI
  showScreen('screen-listas');
  setNavActive(entity);
  setActiveTab(entity);

  // limpia búsqueda si filtramos por cliente (opcional)
  if (qs('#q')) qs('#q').value = '';

  loadList(entity);
}

/* =========================
   Form mock
========================= */
function openForm(kind){
  showScreen('screen-form');
  setNavActive('home');
  if (qs('#formTitle')) qs('#formTitle').textContent = `Crear ${kind} (ejemplo)`;
  if (qs('#formSub')) qs('#formSub').textContent = `${kind.toUpperCase()}-2025-xxxx`;
  toast('Formulario', `Mock: ${kind}`, 'info');
}

/* =========================
   INIT: listeners
========================= */
function initNav(){
  qsa('.cc-navItem').forEach(btn => {
    btn.addEventListener('click', () => {
      const screenId = btn.dataset.screen;
      const entity = btn.dataset.entity;

      if (!screenId) return;

      // Home
      if (screenId === 'screen-home'){
        state.listFilterClientId = null;
        showScreen('screen-home');
        setNavActive('home');
        loadDashboard();
        return;
      }

      // Listas
      if (screenId === 'screen-listas'){
        goToList(entity || 'clientes', null);
        return;
      }

      showScreen(screenId);
      setNavActive(entity || 'home');
    });
  });
}

function initListTabs(){
  qsa('.cc-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      const entity = btn.dataset.entity;
      if (!entity) return;
      state.listFilterClientId = null;
      setActiveTab(entity);
      setNavActive(entity);
      loadList(entity);
    });
  });
}

/* =========================
   Listener global:
   - [data-action] => runAction
   - .cc-item (lista) => abrir detalle
========================= */
document.addEventListener('click', (e) => {
  // 1) Actions
  const actEl = e.target.closest('[data-action]');
  if (actEl){
    e.preventDefault();
    const action = actEl.dataset.action;
    const entity = (actEl.dataset.entity || '').trim();
    const id = (actEl.dataset.id || '').trim();
    runAction(action, entity, id, actEl.dataset);
    return;
  }

  // 2) Click en item de lista
  const item = e.target.closest('.cc-item');
  if (item){
    const entity = item.dataset.entity;
    const id = item.dataset.id;
    if (!entity || !id) return;
    e.preventDefault();

    if (!state.useMock){
      if (entity === 'proformas'){
        loadPresupuestoDetail(id);
        return;
      }
      loadEntityDetail(entity, id);
      return;
    }

    showScreen('screen-detalle');
    setDetailState();
    loadDetail(entity, id);
    return;
  }
});

/* =========================
   Search input (filtro)
========================= */
document.addEventListener('input', (e) => {
  if (e.target && e.target.id === 'q'){
    loadList(state.currentEntity);
  }
});

/* =========================
   INIT APP
========================= */

function __forceRealFromUrl_(){
  try{
    const sp = new URLSearchParams(window.location.search || '');
    if (sp.get('real') === '1'){
      state.useMock = false;
      try{ localStorage.removeItem('cc_useMock'); }catch(_){}
      try{ saveMockPreference_(); }catch(_){}
      try{ updateMockChip_(); }catch(_){}
      try{ toast('Modo', 'REAL activado (?real=1)', 'ok'); }catch(_){}
      return true;
    }
  }catch(_){}
  return false;
}

function __installGlobalErrorCatcher_(){
  try{
    window.addEventListener('error', (e) => {
      const msg = (e && e.message) ? e.message : String(e);
      try{ toast('JS Error', msg, 'error'); } catch(_){ try{ alert('JS Error: ' + msg); }catch(__){} }
    });

    window.addEventListener('unhandledrejection', (e) => {
      const r = e && e.reason ? e.reason : e;
      const msg = (r && r.message) ? r.message : String(r);
      try{ toast('Promise', msg, 'error'); } catch(_){ try{ alert('Promise: ' + msg); }catch(__){} }
    });
  }catch(_){}
}


  param($m)
  $block = $m.Value

  # si encuentra ambas llamadas, las reordena
  if ($block -match '__forceRealFromUrl_\(\);\s*[\r\n]+\s*loadMockPreference_\(\);') {
    $block = $block -replace '__forceRealFromUrl_\(\);\s*([\r\n]+\s*)loadMockPreference_\(\);', 'loadMockPreference_();__installGlobalErrorCatcher_();
  __forceRealFromUrl_();
  loadMockPreference_();
  loadDashboard();
  initNav();
  initListTabs();
  updateMockChip_();

  // estado inicial
  showScreen('screen-home');
  setNavActive('home');
__forceRealFromUrl_();'
  }

  return $block
);

</script>




















