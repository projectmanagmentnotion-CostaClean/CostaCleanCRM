<!-- =========================
ARCHIVO: scripts.html
Lógica UI (mock) + router de acciones + listas + detalle
========================= -->
<script>
/* =========================
   Helpers DOM
========================= */
const qs  = (sel, root=document) => root.querySelector(sel);
const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));

/* =========================
   Estado UI
========================= */
const state = {
  useMock: false,
  currentEntity: 'clientes',        // entidad activa en listas
  listFilterClientId: null,         // filtro por cliente (historial)
  detail: { entity:null, id:null, clientId:null },
  lastScreen: 'screen-home'
};

const STORAGE_KEYS = {
  mockEnabled: 'cc_mock_enabled',
  legacyUseMock: 'cc_useMock',
  legacyUseMockAlt: 'cc_use_mock'
};

const store = {
  presupuestos: [],
  presDetalle: {},
  clientes: [],
  leads: []
};

/* =========================
   Mock: LISTAS
   (Asegúrate de que los IDs coincidan con tus capturas)
========================= */
const MOCK = {
  clientes: [
    { id:'CLI-2025-0007', title:'Marta R.', sub:'NIF: X1234567A · Barcelona', right:'Activo',
      email:'marta@email.com', phone:'+34 600 123 123', city:'Barcelona', status:'Activo' },
    { id:'CLI-2025-0008', title:'Comunidad Pineda', sub:'NIF: B66778899 · Pineda de Mar', right:'Lead',
      email:'admin@pineda.com', phone:'+34 611 222 333', city:'Pineda de Mar', status:'Lead' }
  ],
  leads: [
    { id:'L0009', title:'Comunidad Pineda (Lead)', sub:'Email: admin@pineda.com · Pineda de Mar', right:'Nuevo',
      email:'admin@pineda.com', phone:'+34 611 222 333', city:'Pineda de Mar', status:'Nuevo' }
  ],
  facturas: [
    { id:'F-2025-0123', title:'Factura F-2025-0123', sub:'CLI-2025-0007 · Pendiente', right:'120 €',
      clientId:'CLI-2025-0007', status:'Pendiente', amount:120 },
    { id:'F-2025-0124', title:'Factura F-2025-0124', sub:'CLI-2025-0008 · Pagada', right:'240 €',
      clientId:'CLI-2025-0008', status:'Pagada', amount:240 }
  ],
  proformas: [
    { id:'PRO-2025-0009', title:'Proforma PRO-2025-0009', sub:'CLI-2025-0007 · Enviada', right:'290,40 €',
      clientId:'CLI-2025-0007', status:'Enviada', amount:290.40 }
  ],
  gastos: [
    { id:'G-2025-0042', title:'Gasto G-2025-0042', sub:'Operación · Gasolina', right:'48,00 €',
      clientId:'CLI-2025-0007', status:'Ok', amount:48.00 }
  ]
};

/* =========================
   Mock: DETALLE
   (Si no existe aquí, mostramos fallback)
========================= */
const MOCK_DETAIL = {
  clientes: {
    'CLI-2025-0007': {
      id:'CLI-2025-0007',
      title:'Marta R.',
      sub:'NIF: X1234567A · Barcelona',
      status:'Activo',
      email:'marta@email.com',
      phone:'+34 600 123 123',
      address:'Barcelona'
    },
    'CLI-2025-0008': {
      id:'CLI-2025-0008',
      title:'Comunidad Pineda',
      sub:'NIF: B66778899 · Pineda de Mar',
      status:'Lead',
      email:'admin@pineda.com',
      phone:'+34 611 222 333',
      address:'Pineda de Mar'
    }
  },
  leads: {
    'L0009': {
      id:'L0009',
      title:'Comunidad Pineda (Lead)',
      sub:'Email: admin@pineda.com · Pineda de Mar',
      status:'Nuevo',
      email:'admin@pineda.com',
      phone:'+34 611 222 333',
      address:'Pineda de Mar'
    }
  },
  facturas: {
    'F-2025-0123': {
      id:'F-2025-0123',
      title:'Factura F-2025-0123',
      sub:'CLI-2025-0007 · Pendiente',
      status:'Pendiente',
      amount:120,
      clientId:'CLI-2025-0007'
    },
    'F-2025-0124': {
      id:'F-2025-0124',
      title:'Factura F-2025-0124',
      sub:'CLI-2025-0008 · Pagada',
      status:'Pagada',
      amount:240,
      clientId:'CLI-2025-0008'
    }
  },
  proformas: {
    'PRO-2025-0009': {
      id:'PRO-2025-0009',
      title:'Proforma PRO-2025-0009',
      sub:'CLI-2025-0007 · Enviada',
      status:'Enviada',
      amount:290.40,
      clientId:'CLI-2025-0007'
    }
  },
  gastos: {
    'G-2025-0042': {
      id:'G-2025-0042',
      title:'Gasto G-2025-0042',
      sub:'Operación · Gasolina',
      status:'Ok',
      amount:48.00,
      clientId:'CLI-2025-0007'
    }
  }
};

/* =========================
   UI: Toasts
========================= */
function toast(title, msg, tone='ok'){
  const host = qs('.cc-toasts');
  if (!host) return;

  const el = document.createElement('div');
  el.className = `cc-toast cc-toast--${tone}`;
  el.innerHTML = `
    <div class="cc-toastTitle">${escapeHtml(title)}</div>
    <div class="cc-toastMsg">${escapeHtml(msg)}</div>
  `;
  host.appendChild(el);

  setTimeout(() => el.classList.add('is-in'), 10);
  setTimeout(() => {
    el.classList.remove('is-in');
    setTimeout(() => el.remove(), 200);
  }, 2500);
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function cleanupLegacyMockPreference_(){
  try {
    localStorage.removeItem(STORAGE_KEYS.legacyUseMock);
    localStorage.removeItem(STORAGE_KEYS.legacyUseMockAlt);
  } catch (_) {}
}

async function loadMockPreference_(){
  cleanupLegacyMockPreference_();
  // Forzamos arranque en modo real: no reactivamos mock desde storage ni servidor
  state.useMock = false;
  try {
    localStorage.setItem(STORAGE_KEYS.mockEnabled, 'false');
  } catch (_) {}
  updateMockChip_();
  return state.useMock;
}

function saveMockPreference_(value){
  state.useMock = !!value;
  try {
    localStorage.setItem(STORAGE_KEYS.mockEnabled, state.useMock ? 'true' : 'false');
  } catch (_) {}
  return callServer('apiSetMockPreference', state.useMock)
    .then((res) => {
      state.useMock = !!res?.useMock;
      try {
        localStorage.setItem(STORAGE_KEYS.mockEnabled, state.useMock ? 'true' : 'false');
      } catch (_) {}
      return state.useMock;
    })
    .catch(() => state.useMock);
}

function updateMockChip_(){
  const chip = qs('[data-action="toggle_mock"]');
  if (!chip) return;
  chip.classList.toggle('cc-chip--ok', state.useMock);
  chip.setAttribute('aria-pressed', state.useMock ? 'true' : 'false');
  chip.dataset.state = state.useMock ? 'on' : 'off';
  const dot = chip.querySelector('.cc-dot');
  if (dot){
    dot.classList.toggle('is-on', state.useMock);
    dot.classList.toggle('is-off', !state.useMock);
  }
}

function callServer(fnName, ...args){
  return new Promise((resolve, reject) => {
    const runner = google?.script?.run;
    if (!runner) {
      reject(new Error('API no disponible (google.script.run)'));
      return;
    }
    const call = runner.withSuccessHandler(resolve).withFailureHandler(err => {
      const msg = err?.message || err?.toString() || 'Error desconocido';
      reject(new Error(msg));
    });
    call[fnName].apply(call, args || []);
  });
}

function formatMoney(v){
  const n = Number(v);
  if (isNaN(n)) return '-';
  return `${n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
}

function formatDateText(v){
  if (!v) return '-';
  const d = new Date(v);
  if (isNaN(d.getTime())) return String(v);
  return d.toLocaleDateString('es-ES');
}

function pickValue_(obj, keys){
  if (!obj) return '';
  for (let i = 0; i < keys.length; i++) {
    const v = obj[keys[i]];
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return '';
}

function toNumber_(v){
  const n = Number(v);
  return isNaN(n) ? null : n;
}

function joinParts_(parts){
  return parts.filter(Boolean).join(' | ');
}

function setListState(mode, msg){
  const status = qs('#listState');
  const empty = qs('#listEmpty');
  const box = qs('#listContainer');
  if (!status || !empty || !box) return;

  if (mode === 'loading'){
    status.textContent = msg || 'Cargando...';
    status.style.display = 'block';
    status.style.color = 'inherit';
    empty.style.display = 'none';
    box.innerHTML = '';
    return;
  }

  if (mode === 'error'){
    status.textContent = msg || 'Error al cargar';
    status.style.display = 'block';
    status.style.color = '#b3261e';
    empty.style.display = 'none';
    box.innerHTML = '';
    return;
  }

  if (mode === 'empty'){
    status.style.display = 'none';
    status.style.color = 'inherit';
    empty.textContent = msg || 'Sin registros.';
    empty.style.display = 'block';
    box.innerHTML = '';
    return;
  }

  status.style.display = 'none';
  status.style.color = 'inherit';
  status.textContent = '';
  empty.style.display = 'none';
}

function setDetailState(mode, msg){
  const stateEl = qs('#detailState');
  if (!stateEl) return;
  if (mode === 'loading'){
    stateEl.textContent = msg || 'Cargando...';
    stateEl.style.display = 'block';
    stateEl.style.color = 'inherit';
    return;
  }
  if (mode === 'error'){
    stateEl.textContent = msg || 'No se pudo cargar el detalle';
    stateEl.style.display = 'block';
    stateEl.style.color = '#b3261e';
    return;
  }
  stateEl.style.display = 'none';
  stateEl.style.color = 'inherit';
  stateEl.textContent = '';
}

/* =========================
   UI: Navegación por pantallas
========================= */
function showScreen(screenId){
  qsa('.cc-screen').forEach(s => s.classList.toggle('is-active', s.id === screenId));
  state.lastScreen = screenId;
}

function setNavActive(entity){
  qsa('.cc-navItem').forEach(b => b.classList.toggle('is-active', b.dataset.entity === entity));
}

function setActiveTab(entity){
  state.currentEntity = entity;
  qsa('.cc-tab').forEach(b => b.classList.toggle('is-active', b.dataset.entity === entity));
}

/* =========================
   DASHBOARD
========================= */
function renderDashboardKpis(kpis, periodo, placeholder='-'){
  const money = (v) => (typeof v === 'number') ? formatMoney(v) : placeholder;
  const text = (v) => (v === undefined || v === null || v === '') ? placeholder : String(v);
  const cobradoVal = (typeof kpis?.cobradoMes === 'number') ? kpis.cobradoMes : kpis?.ventasMes;
  const pendienteVal = (typeof kpis?.pendienteMes === 'number') ? kpis.pendienteMes : null;

  if (qs('#kpiVentasMes')) qs('#kpiVentasMes').textContent = money(kpis?.ventasMes);
  if (qs('#kpiCobrado')) qs('#kpiCobrado').textContent = money(cobradoVal);
  if (qs('#kpiPendiente')) qs('#kpiPendiente').textContent = money(pendienteVal);

  if (qs('#kpiFactPendientes')) qs('#kpiFactPendientes').textContent = text(kpis?.facturasPendientes);
  if (qs('#kpiFactPendientesSub')) qs('#kpiFactPendientesSub').textContent = periodo?.monthLabel ? `Mes ${periodo.monthLabel}` : placeholder;

  if (qs('#kpiIvaNeto')) qs('#kpiIvaNeto').textContent = money(kpis?.ivaNetoTrimestre);
  if (qs('#kpiRepercutido')) qs('#kpiRepercutido').textContent = money(kpis?.ivaRepercutidoTrimestre);
  if (qs('#kpiSoportado')) qs('#kpiSoportado').textContent = money(kpis?.ivaSoportadoTrimestre);

  if (qs('#kpiGastoDeducible')) qs('#kpiGastoDeducible').textContent = money(kpis?.gastoDeducibleTrimestre);
  if (qs('#kpiCompras')) qs('#kpiCompras').textContent = placeholder;
  if (qs('#kpiOperacion')) qs('#kpiOperacion').textContent = periodo?.quarterLabel || placeholder;
}

function loadDashboard(){
  const placeholder = state.useMock ? 'Mock' : '...';
  renderDashboardKpis({}, null, placeholder);

  if (state.useMock){
    renderDashboardKpis({
      ventasMes: 0,
      cobradoMes: 0,
      pendienteMes: 0,
      facturasPendientes: 0,
      ivaNetoTrimestre: 0,
      ivaRepercutidoTrimestre: 0,
      ivaSoportadoTrimestre: 0,
      gastoDeducibleTrimestre: 0
    }, null, 'Mock');
    return;
  }

  callServer('apiDashboard')
    .then((res) => {
      const kpis = res?.kpis || res || {};
      renderDashboardKpis(kpis, res?.periodo || null, '-');
    })
    .catch((err) => {
      renderDashboardKpis({}, null, '-');
      toast('Dashboard', err?.message || 'No se pudo cargar los KPIs', 'error');
    });
}

/* =========================
   Diagnostico (overlay)
========================= */
function closeDiagOverlay_(){
  const existing = qs('#ccDiagOverlay');
  if (existing) existing.remove();
}

function openDiagOverlay_(){
  closeDiagOverlay_();
  const overlay = document.createElement('div');
  overlay.id = 'ccDiagOverlay';
  overlay.setAttribute('role', 'dialog');
  overlay.setAttribute('aria-label', 'Diagnóstico');
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,0.55)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = '9999';
  overlay.innerHTML = `
    <div style="background:#0b1014;color:#e7ecf1;max-width:840px;width:90%;max-height:80vh;border-radius:12px;padding:16px;box-shadow:0 12px 32px rgba(0,0,0,0.45);overflow:hidden;border:1px solid #1f2a33;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;">
        <div style="font-weight:700;font-size:16px;">Diagnóstico</div>
        <button type="button" aria-label="Cerrar" style="background:#1f2a33;color:#e7ecf1;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;">Cerrar</button>
      </div>
      <pre id="ccDiagContent" style="background:#0f1620;color:#9ad1ff;padding:12px;border-radius:8px;max-height:65vh;overflow:auto;font-size:12px;line-height:1.4;white-space:pre-wrap;">Cargando diagnóstico...</pre>
    </div>
  `;
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeDiagOverlay_();
  });
  const closeBtn = overlay.querySelector('button');
  if (closeBtn) closeBtn.addEventListener('click', closeDiagOverlay_);
  document.body.appendChild(overlay);

  callServer('apiDiag')
    .then((res) => {
      const pre = qs('#ccDiagContent');
      if (!res) {
        console.error('apiDiag devolvió null');
        toast('Diagnóstico', 'apiDiag devolvió null', 'error');
        if (pre) pre.textContent = 'apiDiag devolvió null';
        return;
      }
      if (pre) pre.textContent = JSON.stringify(res, null, 2);
    })
    .catch((err) => {
      closeDiagOverlay_();
      console.error(err);
      toast('Diagnóstico', err?.message || 'No se pudo obtener el diagnóstico', 'error');
    });
}

/* =========================
   PRESUPUESTOS (API)
========================= */
function mapPresupuestoToView(p){
  if (!p) return null;
  const amount = (typeof p.total === 'number') ? p.total : (typeof p.base === 'number' ? p.base : null);
  const presId = p.id || p.Pres_ID;
  const fechaText = formatDateText(p.fecha || p.fechaRaw);
  const email = p.email || '';
  const phone = p.telefono || p.phone || '';
  const contact = joinParts_([email, phone]);
  return {
    id: presId,
    title: p.cliente || p.clienteId || presId,
    sub: joinParts_([
      presId || '',
      contact,
      fechaText,
      p.estado || ''
    ]),
    status: p.estado || '',
    amount,
    clientId: p.clienteId || '',
    email,
    phone: p.telefono || '',
    address: p.direccion || '',
    base: p.base ?? null,
    total: p.total ?? null,
    pdfUrl: p.pdfUrl || p.PDF_link || (p.raw && p.raw.PDF_link) || '',
    fecha: p.fecha || p.fechaRaw || '',
    notas: p.notas || '',
    lineas: Array.isArray(p.lineas) ? p.lineas : []
  };
}

function mapEntityListRow_(entity, row){
  if (!row) return null;

  if (entity === 'clientes' || entity === 'leads'){
    const id = pickValue_(row, ['Cliente_ID', 'cliente_id', 'CLI_ID', 'cli_id', 'id', 'ID', 'Lead_ID']) || row.id;
    const name = row.nombre || pickValue_(row, ['Nombre', 'Cliente', 'Lead_Nombre', 'Nombre / Razón social', 'Razon_social', 'RazonSocial', 'nombre']);
    const status = row.estado || pickValue_(row, ['Estado', 'Status']);
    return {
      id,
      title: name || 'Cliente',
      sub: id || '',
      right: status || '',
      status: status || ''
    };
  }

  if (entity === 'facturas'){
    const id = pickValue_(row, ['Factura_ID', 'Numero_factura', 'ID']);
    const cliente = pickValue_(row, ['Cliente', 'Cliente_nombre', 'Nombre']);
    const clienteId = pickValue_(row, ['Cliente_ID', 'ClienteId', 'Lead_ID']);
    const status = pickValue_(row, ['Estado', 'Status']);
    const total = toNumber_(pickValue_(row, ['Total', 'Importe_total', 'Total_con_IVA', 'Importe']));
    const base = toNumber_(pickValue_(row, ['Base', 'Subtotal', 'Base_imponible']));
    const amount = total != null ? total : base;
    const email = pickValue_(row, ['Email', 'Email_cliente']);
    const phone = pickValue_(row, ['Telefono', 'Lead_Telefono', 'Phone']);
    const contact = joinParts_([email, phone]);
    return {
      id,
      title: cliente || clienteId || id || 'Factura',
      sub: joinParts_([
        id || '',
        contact ? `Contacto: ${contact}` : '',
        status || ''
      ]),
      right: amount != null ? formatMoney(amount) : (status || ''),
      status: status || '',
      clientId: clienteId || ''
    };
  }

  if (entity === 'gastos'){
    const id = pickValue_(row, ['Gasto_ID', 'ID']);
    const proveedor = pickValue_(row, ['Proveedor', 'Empresa']);
    const concepto = pickValue_(row, ['Concepto', 'Descripcion', 'Detalle']);
    const categoria = pickValue_(row, ['Categoria', 'Tipo']);
    const total = toNumber_(pickValue_(row, ['Total', 'Importe_total', 'Total_con_IVA', 'Importe']));
    const base = toNumber_(pickValue_(row, ['Base', 'Subtotal', 'Base_imponible']));
    const amount = total != null ? total : base;
    return {
      id,
      title: concepto || proveedor || id || 'Gasto',
      sub: joinParts_([id || '', proveedor, categoria]),
      right: amount != null ? formatMoney(amount) : (categoria || ''),
      status: categoria || '',
      clientId: pickValue_(row, ['Cliente_ID', 'ClienteId']) || ''
    };
  }

  return null;
}

function mapEntityDetail_(entity, row){
  if (!row) return null;

  if (entity === 'clientes' || entity === 'leads'){
    const id = row.id || pickValue_(row, ['Cliente_ID', 'cliente_id', 'CLI_ID', 'cli_id', 'Lead_ID', 'ID']);
    const name = row.nombre || pickValue_(row, ['Nombre', 'Cliente', 'Lead_Nombre', 'Nombre / Razón social', 'Razon_social', 'RazonSocial', 'nombre']);
    const email = row.email || pickValue_(row, ['Email', 'Email_cliente', 'Lead_Email', 'email']);
    const phone = row.telefono || pickValue_(row, ['Telefono', 'Lead_Telefono', 'Phone', 'telefono']);
    const address = pickValue_(row, ['Direccion', 'Address', 'Direccion_cliente', 'direccion']);
    const status = row.estado || pickValue_(row, ['Estado', 'Status', 'estado']);
    return {
      id,
      title: name || id,
      sub: joinParts_([
        email ? `Email: ${email}` : '',
        phone ? `Tel: ${phone}` : ''
      ]),
      status: status || '',
      email,
      phone,
      address
    };
  }

  if (entity === 'facturas'){
    const id = pickValue_(row, ['Factura_ID', 'Numero_factura', 'ID']);
    const cliente = pickValue_(row, ['Cliente', 'Cliente_nombre', 'Nombre']);
    const clienteId = pickValue_(row, ['Cliente_ID', 'ClienteId', 'Lead_ID']);
    const status = pickValue_(row, ['Estado', 'Status']);
    const fecha = pickValue_(row, ['Fecha', 'Fecha_emision', 'Fecha_factura']);
    const total = toNumber_(pickValue_(row, ['Total', 'Importe_total', 'Total_con_IVA', 'Importe']));
    const base = toNumber_(pickValue_(row, ['Base', 'Subtotal', 'Base_imponible']));
    const amount = total != null ? total : base;
    return {
      id,
      title: id ? `Factura ${id}` : (cliente || 'Factura'),
      status: status || '',
      amount,
      base,
      total,
      clientId: clienteId || '',
      fecha
    };
  }

  if (entity === 'gastos'){
    const id = pickValue_(row, ['Gasto_ID', 'ID']);
    const proveedor = pickValue_(row, ['Proveedor', 'Empresa']);
    const concepto = pickValue_(row, ['Concepto', 'Descripcion', 'Detalle']);
    const categoria = pickValue_(row, ['Categoria', 'Tipo']);
    const fecha = pickValue_(row, ['Fecha']);
    const total = toNumber_(pickValue_(row, ['Total', 'Importe_total', 'Total_con_IVA', 'Importe']));
    const base = toNumber_(pickValue_(row, ['Base', 'Subtotal', 'Base_imponible']));
    const amount = total != null ? total : base;
    return {
      id,
      title: concepto || proveedor || id || 'Gasto',
      status: categoria || '',
      amount,
      base,
      total,
      clientId: pickValue_(row, ['Cliente_ID', 'ClienteId']) || '',
      fecha
    };
  }

  return null;
}

async function fetchEntityList(entity, search, filterClientId){
  const label = entity === 'clientes' ? 'clientes'
    : entity === 'leads' ? 'leads'
      : entity === 'facturas' ? 'facturas'
        : entity === 'gastos' ? 'gastos'
          : 'registros';
  setListState('loading', `Cargando ${label}...`);

  try {
    let items = [];
    if (entity === 'clientes'){
      items = await callServer('apiListClientes', { q: search || '' });
    } else if (entity === 'leads'){
      items = await callServer('apiListLeads', { q: search || '' });
    } else {
      items = await callServer('apiList', entity, { q: search || '', limit: 120 });
    }

    let rows = (Array.isArray(items) ? items : []).map(r => mapEntityListRow_(entity, r)).filter(r => r && r.id);
    if (filterClientId && entity !== 'clientes'){
      const needle = String(filterClientId).toLowerCase();
      rows = rows.filter(r => (r.clientId || '').toString().toLowerCase() === needle);
    }

    if (!rows.length){
      renderListItems(entity, []);
      setListState('empty', 'Sin registros.');
      return;
    }

    setListState();
    renderListItems(entity, rows);
  } catch (err) {
    console.error(err);
    setListState('error', err.message || 'No se pudo cargar');
    toast('Error', err.message || 'No se pudo cargar', 'error');
  }
}

async function loadEntityDetail(entity, id){
  showScreen('screen-detalle');
  setDetailState('loading', 'Cargando detalle...');
  try {
    const res = await callServer('apiGet', entity, id);
    let payload = res;

    if (entity === 'clientes' && res && typeof res === 'object' && 'ok' in res){
      if (res.ok === false){
        const tried = Array.isArray(res?.meta?.sheetTried) ? res.meta.sheetTried.join(', ') : '-';
        const cols = Array.isArray(res?.meta?.idColumnCandidates) ? res.meta.idColumnCandidates.join(', ') : '-';
        const msg = `No se encontró información para ID: ${id}`;
        const detailMsg = `Hojas: ${tried} | Columnas ID: ${cols}`;
        setDetailState('error', `${msg}\n${detailMsg}`);
        toast('Error', msg, 'error');
        return;
      }
      payload = res.data || null;
    }

    const view = mapEntityDetail_(entity, payload);
    if (!view) throw new Error(`No se encontró información para ID: ${id}`);
    setDetailState();
    loadDetail(entity, view.id, view);
  } catch (err) {
    console.error(err);
    const msg = err?.message || 'No se pudo cargar el detalle';
    const friendly = msg.toLowerCase().includes('no se encontr') ? `No se encontró información para ID: ${id}` : msg;
    setDetailState('error', friendly);
    toast('Error', friendly, 'error');
  }
}

async function fetchPresupuestos(search, filterClientId){
  setListState('loading', 'Cargando presupuestos...');
  try {
    const res = await callServer('apiListPresupuestos', { q: search || '', includeHistorial: false });
    const items = Array.isArray(res) ? res : (Array.isArray(res?.items) ? res.items : []);
    store.presupuestos = items;

    let list = store.presupuestos.slice();
    if (filterClientId){
      const needle = String(filterClientId).toLowerCase();
      list = list.filter(p => {
        const cid = (p.clienteId || p.Cliente_ID || p.Lead_ID || '').toString().toLowerCase();
        const cname = (p.cliente || '').toString().toLowerCase();
        return cid === needle || cname.includes(needle);
      });
    }

    if (!list.length){
      renderListItems('proformas', []);
      setListState('empty', filterClientId ? 'Sin presupuestos para este cliente' : 'Sin presupuestos aún');
      return;
    }

    const rows = list.map(p => {
      const view = mapPresupuestoToView(p);
      return {
        id: view.id,
        title: view.title,
        sub: view.sub,
        right: view.amount != null ? formatMoney(view.amount) : '',
        status: view.status,
        clientId: view.clientId
      };
    });

    setListState();
    renderListItems('proformas', rows);
  } catch (err) {
    console.error(err);
    setListState('error', err.message || 'No se pudo cargar presupuestos');
    toast('Error', err.message || 'No se pudo cargar presupuestos', 'error');
  }
}

async function loadPresupuestoDetail(id){
  showScreen('screen-detalle');
  setDetailState('loading', 'Cargando presupuesto...');
  try {
    const cached = store.presDetalle[id];
    const res = cached || await callServer('apiGetPresupuesto', id);
    if (!cached) store.presDetalle[id] = res;

    const view = mapPresupuestoToView(res);
    if (!view) throw new Error('No se encontró información del presupuesto');

    setDetailState();
    loadDetail('proformas', view.id, view);
  } catch (err) {
    console.error(err);
    setDetailState('error', err.message || 'Error al obtener presupuesto');
    toast('Error', err.message || 'No se pudo cargar el presupuesto', 'error');
  }
}

/* =========================
   LISTAS
========================= */
function renderListItems(entity, rows){
  const box = qs('#listContainer');
  const empty = qs('#listEmpty');
  if (!box) return;

  if (!rows || !rows.length){
    box.innerHTML = '';
    if (empty) empty.style.display = 'block';
    return;
  }
  if (empty) empty.style.display = 'none';

  box.innerHTML = rows.map(r => {
    const itemId = (entity === 'clientes')
      ? (r.Cliente_ID || r.CLI_ID || r.id || r.ID)
      : (r.id || r.ID);
    return `
    <button class="cc-item" type="button" data-entity="${escapeHtml(entity)}" data-id="${escapeHtml(itemId || '')}">
      <div class="cc-itemMain">
        <div class="cc-itemTitle">${escapeHtml(r.title || r.id)}</div>
        <div class="cc-itemSub">${escapeHtml(r.sub || '')}</div>
      </div>
      <div class="cc-itemRight">${escapeHtml(r.right || '')}</div>
    </button>
  `;
  }).join('');
}

function loadList(entity){
  const q = (qs('#q')?.value || '').toLowerCase().trim();

  if (entity === 'proformas'){
    fetchPresupuestos(q, state.listFilterClientId);
    return;
  }
  fetchEntityList(entity, q, state.listFilterClientId);
}

/* =========================
   DETALLE (render reusable)
========================= */
function loadDetail(entity, id, detailData){
  state.detail.entity = entity;
  state.detail.id = id;

  const fallback = (MOCK_DETAIL?.[entity]?.[id]) || null;
  const data = detailData || fallback;
  state.detail.clientId = data?.clientId || data?.clienteId || null;

  const statusText = data?.status || data?.estado || '';
  const amountVal = (typeof data?.amount === 'number')
    ? data.amount
    : (typeof data?.total === 'number')
      ? data.total
      : (typeof data?.base === 'number' ? data.base : null);

  const subPieces = [];
  if (data?.fecha) subPieces.push(`Fecha: ${formatDateText(data.fecha)}`);
  if (statusText) subPieces.push(`Estado: ${statusText}`);
  if (data?.sub && !subPieces.length) subPieces.push(data.sub);

  qs('#detailId') && (qs('#detailId').textContent = id || '-');
  qs('#detailTitle') && (qs('#detailTitle').textContent = data?.title || data?.cliente || data?.id || id || 'Sin datos');
  qs('#detailSub') && (qs('#detailSub').textContent = subPieces.join(' | ') || data?.sub || 'Sin informacion');

  const pill = qs('#detailTypePill');
  if (pill){
    pill.textContent = entity === 'proformas' ? 'Presupuesto' : entity;
  }

  const statusPill = qs('#detailStatusPill');
  if (statusPill){
    statusPill.style.display = statusText ? 'inline-flex' : 'none';
    statusPill.textContent = statusText || '-';
  }

  const amountEl = qs('#detailAmount');
  if (amountEl){
    amountEl.style.display = amountVal != null ? 'block' : 'none';
    amountEl.textContent = amountVal != null ? formatMoney(amountVal) : '';
  }

  renderDetail(entity, id, data);
  renderDetailLines(data?.lineas);

  if (entity === 'clientes') setNavActive('clientes');
  if (entity === 'leads') setNavActive('clientes');
  if (entity === 'facturas') setNavActive('facturas');
  if (entity === 'proformas') setNavActive('proformas');
  if (entity === 'gastos') setNavActive('gastos');
}

function renderDetail(entity, id, data){
  const actionsMain = qs('#detailActions');
  const meta = qs('#detailMeta');
  const quick = qs('#detailQuickActions');

  if (actionsMain) actionsMain.innerHTML = '';
  if (meta) meta.innerHTML = '';
  if (quick) quick.innerHTML = '';

  const status = data?.status || data?.estado || '';
  const clientId = data?.clientId || data?.clienteId || null;
  const amountVal = (typeof data?.amount === 'number') ? data.amount : (typeof data?.total === 'number' ? data.total : null);
  const baseVal = (typeof data?.base === 'number') ? data.base : null;
  const fechaVal = data?.fecha || '';

  // LEAD
  if (entity === 'leads'){
    const email = data?.email || '-';
    const phone = data?.phone || '-';
    const address = data?.address || '-';

    if (actionsMain){
      actionsMain.innerHTML = `
        <button class="cc-btn cc-btn--primary cc-btn--wide" type="button" data-action="crear_presupuesto_lead" data-entity="leads" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">+</span> Crear presupuesto
        </button>
      `;
    }

    if (meta){
      meta.innerHTML = `
        <div class="cc-metaCard">
          <div class="cc-metaLabel">EMAIL</div>
          <div class="cc-metaValue">${escapeHtml(email)}</div>
        </div>
        <div class="cc-metaCard">
          <div class="cc-metaLabel">TELEFONO</div>
          <div class="cc-metaValue">${escapeHtml(phone)}</div>
        </div>
        <div class="cc-metaCard">
          <div class="cc-metaLabel">DIRECCION</div>
          <div class="cc-metaValue">${escapeHtml(address)}</div>
        </div>
      `;
    }

    if (quick){
      quick.innerHTML = `
        <button class="cc-quickItem" type="button" data-action="volver" data-entity="${escapeHtml(entity)}" data-id="${escapeHtml(id)}">
          <div class="cc-quickLeft">
            <div class="cc-quickTitle">Volver</div>
            <div class="cc-quickSub">Regresar a listas</div>
          </div>
          <div class="cc-quickRight" aria-hidden="true">&larr;</div>
        </button>
      `;
    }

    return;
  }

  // CLIENTE
  if (entity === 'clientes'){
    const email = data?.email || '—';
    const phone = data?.phone || '—';
    const address = data?.address || '—';

    // Acciones principales grandes (como la versión que quieres)
    if (actionsMain){
      actionsMain.innerHTML = `
        <button class="cc-btn cc-btn--primary cc-btn--wide" type="button" data-action="crear_proforma" data-entity="clientes" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">➕</span> Crear proforma
        </button>
        <button class="cc-btn cc-btn--primary cc-btn--wide" type="button" data-action="crear_factura" data-entity="clientes" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">🧾</span> Crear factura
        </button>
        <button class="cc-btn cc-btn--wide" type="button" data-action="ver_historial" data-entity="clientes" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">📚</span> Ver historial
        </button>
      `;
    }

    // Meta cards (Email / Teléfono / Dirección)
    if (meta){
      meta.innerHTML = `
        <div class="cc-metaCard">
          <div class="cc-metaLabel">EMAIL</div>
          <div class="cc-metaValue">${escapeHtml(email)}</div>
        </div>
        <div class="cc-metaCard">
          <div class="cc-metaLabel">TELÉFONO</div>
          <div class="cc-metaValue">${escapeHtml(phone)}</div>
        </div>
        <div class="cc-metaCard">
          <div class="cc-metaLabel">DIRECCIÓN</div>
          <div class="cc-metaValue">${escapeHtml(address)}</div>
        </div>
      `;
    }

    // Quick actions (lista)
    if (quick){
      quick.innerHTML = `
        <button class="cc-quickItem" type="button" data-action="wa_chat" data-entity="clientes" data-id="${escapeHtml(id)}">
          <div class="cc-quickLeft">
            <div class="cc-quickTitle">WhatsApp</div>
            <div class="cc-quickSub">Abrir chat rápido</div>
          </div>
          <div class="cc-quickRight" aria-hidden="true">↗</div>
        </button>

        <button class="cc-quickItem" type="button" data-action="call_phone" data-entity="clientes" data-id="${escapeHtml(id)}">
          <div class="cc-quickLeft">
            <div class="cc-quickTitle">Llamar</div>
            <div class="cc-quickSub">Marcar teléfono</div>
          </div>
          <div class="cc-quickRight" aria-hidden="true">↗</div>
        </button>

        <button class="cc-quickItem" type="button" data-action="send_email" data-entity="clientes" data-id="${escapeHtml(id)}">
          <div class="cc-quickLeft">
            <div class="cc-quickTitle">Email</div>
            <div class="cc-quickSub">Enviar correo</div>
          </div>
          <div class="cc-quickRight" aria-hidden="true">↗</div>
        </button>

        <button class="cc-quickItem" type="button" data-action="copy_id" data-entity="clientes" data-id="${escapeHtml(id)}">
          <div class="cc-quickLeft">
            <div class="cc-quickTitle">Copiar datos</div>
            <div class="cc-quickSub">ID + contacto</div>
          </div>
          <div class="cc-quickRight" aria-hidden="true">⧉</div>
        </button>

        <button class="cc-quickItem" type="button" data-action="ver_proformas" data-entity="clientes" data-id="${escapeHtml(id)}">
          <div class="cc-quickLeft">
            <div class="cc-quickTitle">Ver proformas</div>
            <div class="cc-quickSub">Filtrar por cliente</div>
          </div>
          <div class="cc-quickRight" aria-hidden="true">→</div>
        </button>

        <button class="cc-quickItem" type="button" data-action="ver_gastos" data-entity="clientes" data-id="${escapeHtml(id)}">
          <div class="cc-quickLeft">
            <div class="cc-quickTitle">Ver gastos</div>
            <div class="cc-quickSub">Filtrar por cliente</div>
          </div>
          <div class="cc-quickRight" aria-hidden="true">→</div>
        </button>
      `;
    }

    return;
  }

  // FACTURA / PROFORMA / GASTO
  state.detail.clientId = clientId;

  if (actionsMain){
    // Botones principales para documentos
    if (entity === 'facturas'){
      actionsMain.innerHTML = `
        <button class="cc-btn cc-btn--primary cc-btn--wide" type="button" data-action="abrir_pdf" data-entity="facturas" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">📄</span> Abrir PDF
        </button>
        <button class="cc-btn cc-btn--wide" type="button" data-action="marcar_pagada" data-entity="facturas" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">✅</span> Marcar pagada
        </button>
        <button class="cc-btn cc-btn--wide" type="button" data-action="volver_cliente" data-entity="facturas" data-id="${escapeHtml(id)}" data-clientid="${escapeHtml(clientId||'')}">
          <span aria-hidden="true"><</span> Volver a cliente
        </button>
      `;
    
    } else if (entity === 'proformas'){
      actionsMain.innerHTML = `
        <button class="cc-btn cc-btn--primary cc-btn--wide" type="button" data-action="generar_pdf" data-entity="proformas" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">?</span> Generar PDF
        </button>
        <button class="cc-btn cc-btn--primary cc-btn--wide" type="button" data-action="abrir_pdf" data-entity="proformas" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">??</span> Abrir PDF
        </button>
        <button class="cc-btn cc-btn--wide" type="button" data-action="aceptar_proforma" data-entity="proformas" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">??</span> Aceptar
        </button>
        <button class="cc-btn cc-btn--wide" type="button" data-action="crear_factura" data-entity="proformas" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">??</span> Crear factura
        </button>
        <button class="cc-btn cc-btn--wide" type="button" data-action="perder_proforma" data-entity="proformas" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">?</span> Marcar perdida
        </button>
      `;
    } else if (entity === 'gastos'){
      actionsMain.innerHTML = `
        <button class="cc-btn cc-btn--primary cc-btn--wide" type="button" data-action="adjuntar_pdf" data-entity="gastos" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">📎</span> Adjuntar PDF
        </button>
        <button class="cc-btn cc-btn--wide" type="button" data-action="editar_gasto" data-entity="gastos" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">✏️</span> Editar gasto
        </button>
        <button class="cc-btn cc-btn--wide" type="button" data-action="eliminar_gasto" data-entity="gastos" data-id="${escapeHtml(id)}">
          <span aria-hidden="true">🗑</span> Eliminar
        </button>
      `;
    }
  }

  // Meta info del documento
  if (meta){
    meta.innerHTML = `
      <div class="cc-metaCard">
        <div class="cc-metaLabel">CLIENTE</div>
        <div class="cc-metaValue">${escapeHtml(clientId || '—')}</div>
      </div>
      <div class="cc-metaCard">
        <div class="cc-metaLabel">ESTADO</div>
        <div class="cc-metaValue">${escapeHtml(data?.status || '—')}</div>
      </div>
      <div class="cc-metaCard">
        <div class="cc-metaLabel">IMPORTE</div>
        <div class="cc-metaValue">${escapeHtml((typeof data?.amount === 'number') ? `${data.amount.toFixed(2)} €` : '—')}</div>
      </div>
    `;
  }

  // Quick actions mínimas para docs
  if (quick){
    quick.innerHTML = `
      <button class="cc-quickItem" type="button" data-action="volver" data-entity="${escapeHtml(entity)}" data-id="${escapeHtml(id)}">
        <div class="cc-quickLeft">
          <div class="cc-quickTitle">Volver</div>
          <div class="cc-quickSub">Regresar a listas</div>
        </div>
        <div class="cc-quickRight" aria-hidden="true">←</div>
      </button>
    `;
  }
}

function renderDetailLines(lines){
  const box = qs('#detailLines');
  const empty = qs('#detailLinesEmpty');
  if (!box || !empty) return;

  if (!Array.isArray(lines) || !lines.length){
    box.innerHTML = '';
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';
  box.innerHTML = lines.map(l => {
    const parts = [];
    if (l?.cantidad != null && l?.precio != null){
      parts.push(`Cant: ${l.cantidad} x ${formatMoney(l.precio)}`);
    } else if (l?.cantidad != null){
      parts.push(`Cant: ${l.cantidad}`);
    }
    if (l?.dto != null) parts.push(`Dto: ${l.dto}%`);
    if (l?.iva != null) parts.push(`IVA: ${l.iva}%`);

    const meta = parts.length ? parts.join(' · ') : '';
    const total = (typeof l?.subtotal === 'number')
      ? l.subtotal
      : (typeof l?.base === 'number' ? l.base : null);

    return `
      <div class="cc-lineItem">
        <div class="cc-lineTitle">${escapeHtml(l?.concepto || l?.descripcion || l?.Descripcion || '')}</div>
        <div class="cc-lineSub">${escapeHtml(total != null ? formatMoney(total) : '')}</div>
        <div class="cc-lineMeta">${escapeHtml(meta)}</div>
      </div>
    `;
  }).join('');
}

/* =========================
   Router de acciones (ÚNICO)
   Maneja SOLO elementos con [data-action]
========================= */
function runAction(action, entity, id, dataset){
  const a = (action || '').toLowerCase().trim();

  // Toggle mock
  if (a === 'toggle_mock'){
    const prev = state.useMock;
    const next = !prev;
    const currentEntity = state.currentEntity || 'clientes';

    state.useMock = next;
    updateMockChip_();
    loadList(currentEntity);
    loadDashboard();

    saveMockPreference_(next)
      .then((useMock) => {
        state.useMock = !!useMock;
        updateMockChip_();
        loadDashboard();
        toast('Mock', state.useMock ? 'Activado' : 'Desactivado', 'info');
        if (state.useMock !== next) loadList(currentEntity);
      })
      .catch((err) => {
        state.useMock = prev;
        updateMockChip_();
        loadList(currentEntity);
        loadDashboard();
        toast('Mock', err?.message || 'No se pudo guardar la preferencia', 'error');
      });
    return;
  }

  // Dashboard shortcuts
  if (a === 'go_form_cliente'){ openForm('Cliente'); return; }
  if (a === 'go_form_factura'){ openForm('Factura'); return; }
  if (a === 'go_form_proforma'){ openForm('Proforma'); return; }
  if (a === 'go_form_gasto'){ openForm('Gasto'); return; }

  // Cierre / ver todo / filtros (mock)
  if (a === 'cierre_trimestre'){ toast('Cierre', 'Mock: iniciar cierre de trimestre', 'info'); return; }
  if (a === 'ver_todo'){ toast('Movimientos', 'Mock: ver todo', 'info'); return; }
  if (a === 'abrir_filtro'){ openDiagOverlay_(); return; }

  // Acciones de CLIENTE (detalle)
  if (a === 'crear_proforma'){
    toast('Listo', `Crear proforma desde ${id} (mock)`, 'ok');
    goToList('proformas', id);
    return;
  }
  if (a === 'crear_factura'){
    toast('Listo', `Crear factura desde ${id} (mock)`, 'ok');
    goToList('facturas', id);
    return;
  }
  if (a === 'crear_presupuesto_lead'){
    if (state.useMock){
      toast('Listo', `Crear presupuesto para ${id} (mock)`, 'ok');
      goToList('proformas', null);
      return;
    }
    if (!id){
      toast('Error', 'Lead_ID vacio', 'info');
      return;
    }
    google.script.run
      .withSuccessHandler((res) => {
        const presId = res && res.presId ? res.presId : '(sin id)';
        toast('Listo', `Presupuesto creado: ${presId}`, 'ok');
        goToList('proformas', null);
      })
      .withFailureHandler((err) => {
        toast('Error', err && err.message ? err.message : String(err), 'info');
      })
      .apiCrearPresupuestoLead(id);
    return;
  }
  if (a === 'ver_historial'){
    toast('Historial', `Mostrando facturas de ${id} (mock)`, 'info');
    goToList('facturas', id);
    return;
  }

  if (a === 'ver_proformas'){
    goToList('proformas', id);
    return;
  }
  if (a === 'ver_gastos'){
    goToList('gastos', id);
    return;
  }

  // Quick actions cliente
  if (a === 'wa_chat'){
    toast('WhatsApp', `Mock: abrir chat de ${id}`, 'info');
    return;
  }
  if (a === 'call_phone'){
    toast('Llamar', `Mock: llamar a ${id}`, 'info');
    return;
  }
  if (a === 'send_email'){
    toast('Email', `Mock: enviar email a ${id}`, 'info');
    return;
  }
  if (a === 'copy_id'){
    // Intento copiar
    const d = MOCK_DETAIL?.clientes?.[id];
    const txt = `ID: ${id}\nEmail: ${d?.email || '—'}\nTel: ${d?.phone || '—'}`;
    navigator.clipboard?.writeText(txt).then(
      () => toast('Copiado', 'Datos copiados al portapapeles', 'ok'),
      () => toast('Copiar', 'No se pudo copiar (permiso del navegador)', 'info')
    );
    return;
  }

  // Acciones de FACTURA / PROFORMA / GASTO (detalle)
  if (a === 'generar_pdf'){
    if (state.useMock){
      toast('PDF', `Mock: generar PDF de ${id}`, 'ok');
      return;
    }
    if (entity !== 'proformas'){
      toast('PDF', 'Generar PDF solo disponible en proformas desde la app', 'info');
      return;
    }
    toast('Generando', `Generando PDF ${id}...`, 'info');
    callServer('apiGeneratePresupuestoPdf', id)
      .then((res) => {
        const url = res && (res.pdfUrl || res.url);
        if (store.presDetalle[id]) store.presDetalle[id].pdfUrl = url || store.presDetalle[id].pdfUrl;
        if (url){
          toast('PDF', 'PDF listo', 'ok');
          try { window.open(url, '_blank'); } catch (_) {}
        } else {
          toast('PDF', 'No se recibio URL del PDF', 'info');
        }
      })
      .catch((err) => toast('Error', err?.message || 'No se pudo generar el PDF', 'error'));
    return;
  }
  if (a === 'abrir_pdf'){
    if (entity === 'proformas' && !state.useMock){
      const detail = store.presDetalle[id];
      const saved = detail?.pdfUrl || detail?.PDF_link || '';
      if (saved){
        try { window.open(saved, '_blank'); } catch (_) { toast('PDF', saved, 'info'); }
        return;
      }
      toast('PDF', 'Generando PDF porque no hay enlace guardado...', 'info');
      callServer('apiGeneratePresupuestoPdf', id)
        .then((res) => {
          const link = res && (res.pdfUrl || res.url);
          if (store.presDetalle[id]) store.presDetalle[id].pdfUrl = link || store.presDetalle[id].pdfUrl;
          if (link){
            try { window.open(link, '_blank'); } catch (_) {}
          } else {
            toast('PDF', 'No se pudo obtener el PDF', 'error');
          }
        })
        .catch((err) => toast('Error', err?.message || 'No se pudo abrir el PDF', 'error'));
      return;
    }
    toast('PDF', `Mock: abrir PDF de ${id}`, 'ok');
    return;
  }
  if (a === 'marcar_pagada'){ toast('Listo', `Factura ${id} marcada como pagada (mock)`, 'ok'); return; }
  if (a === 'aceptar_proforma'){ toast('Listo', `Proforma ${id} aceptada (mock)`, 'ok'); return; }
  if (a === 'convertir_factura'){ toast('Listo', `Convertir ${id} a factura (mock)`, 'ok'); return; }
  if (a === 'crear_factura'){
    if (state.useMock){
      toast('Listo', `Crear factura desde ${id} (mock)`, 'ok');
      return;
    }
    if (!id){
      toast('Error', 'Pres_ID vacio', 'info');
      return;
    }
    toast('Factura', `Creando factura desde ${id}...`, 'info');
    callServer('apiCrearFacturaDesdePresupuesto', id, { regenerarPdf: false })
      .then((res) => {
        const facturaId = res?.facturaId || '';
        const pdfUrl = res?.pdfUrl || '';
        const msg = res?.alreadyExisted ? `Factura existente: ${facturaId}` : `Factura creada: ${facturaId}`;
        toast('Factura', msg, 'ok');
        if (pdfUrl){
          try { window.open(pdfUrl, '_blank'); } catch (_) {}
        }
      })
      .catch((err) => toast('Error', err?.message || 'No se pudo crear la factura', 'error'));
    return;
  }
  if (a === 'perder_proforma'){ toast('Listo', `Proforma ${id} marcada como perdida (mock)`, 'ok'); return; }
  if (a === 'adjuntar_pdf'){ toast('Listo', `Adjuntar PDF a ${id} (mock)`, 'ok'); return; }
  if (a === 'editar_gasto'){ toast('Editar', `Editar gasto ${id} (mock)`, 'info'); return; }
  if (a === 'eliminar_gasto'){ toast('Eliminado', `Gasto ${id} eliminado (mock)`, 'ok'); return; }

  // Volver a cliente (desde factura)
  if (a === 'volver_cliente'){
    const cid = dataset?.clientid || state.detail.clientId;
    if (!cid){ toast('Cliente', 'No hay clientId en el mock', 'info'); return; }
    showScreen('screen-detalle');
    loadDetail('clientes', cid);
    return;
  }

  // Volver / cancelar / guardar form
  if (a === 'volver'){
    // vuelve a listas si venías de detalle o form; si no, home
    if (state.lastScreen === 'screen-detalle' || state.lastScreen === 'screen-form'){
      showScreen('screen-listas');
      setNavActive(state.currentEntity);
      loadList(state.currentEntity);
    } else {
      showScreen('screen-home');
      setNavActive('home');
      loadDashboard();
    }
    return;
  }
  if (a === 'guardar_form'){
    toast('Guardado', 'Mock: registro guardado', 'ok');
    showScreen('screen-home');
    setNavActive('home');
    return;
  }

  // fuente / pendientes etc
  if (a === 'ver_fuente'){
    if (state.useMock){
      toast('Fuente', 'Mock: abrir spreadsheet', 'info');
      return;
    }
    callServer('apiPresupuestosDebug')
      .then((res) => {
        const pres = res?.sheets?.PRESUPUESTOS || {};
        const hist = res?.sheets?.HISTORIAL_PRESUPUESTOS || {};
        const msg = `SS: ${res?.spreadsheetId || '-'} | PRESUPUESTOS: ${pres.dataRows || 0} | HIST: ${hist.dataRows || 0}`;
        toast('Fuente', msg, 'info');
      })
      .catch((err) => {
        toast('Fuente', err?.message || 'No se pudo leer el debug', 'info');
      });
    return;
  }
  if (a === 'ir_facturas_pendientes'){ goToList('facturas', null); return; }

  // default
  toast('Info', `Acción no implementada: ${action}`, 'info');
}

/* =========================
   Navegación a listas
========================= */
function goToList(entity, filterClientId){
  state.currentEntity = entity;
  state.listFilterClientId = filterClientId || null;

  // UI
  showScreen('screen-listas');
  setNavActive(entity);
  setActiveTab(entity);

  // limpia búsqueda si filtramos por cliente (opcional)
  if (qs('#q')) qs('#q').value = '';

  loadList(entity);
}

/* =========================
   Form mock
========================= */
function openForm(kind){
  showScreen('screen-form');
  setNavActive('home');
  if (qs('#formTitle')) qs('#formTitle').textContent = `Crear ${kind} (ejemplo)`;
  if (qs('#formSub')) qs('#formSub').textContent = `${kind.toUpperCase()}-2025-xxxx`;
  toast('Formulario', `Mock: ${kind}`, 'info');
}

/* =========================
   INIT: listeners
========================= */
function initNav(){
  qsa('.cc-navItem').forEach(btn => {
    btn.addEventListener('click', () => {
      const screenId = btn.dataset.screen;
      const entity = btn.dataset.entity;

      if (!screenId) return;

      // Home
      if (screenId === 'screen-home'){
        state.listFilterClientId = null;
        showScreen('screen-home');
        setNavActive('home');
        loadDashboard();
        return;
      }

      // Listas
      if (screenId === 'screen-listas'){
        goToList(entity || 'clientes', null);
        return;
      }

      showScreen(screenId);
      setNavActive(entity || 'home');
    });
  });
}

function initListTabs(){
  qsa('.cc-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      const entity = btn.dataset.entity;
      if (!entity) return;
      state.listFilterClientId = null;
      setActiveTab(entity);
      setNavActive(entity);
      loadList(entity);
    });
  });
}

/* =========================
   Listener global:
   - [data-action] => runAction
   - .cc-item (lista) => abrir detalle
========================= */
document.addEventListener('click', (e) => {
  // 1) Actions
  const actEl = e.target.closest('[data-action]');
  if (actEl){
    e.preventDefault();
    const action = actEl.dataset.action;
    const entity = (actEl.dataset.entity || '').trim();
    const id = (actEl.dataset.id || '').trim();
    runAction(action, entity, id, actEl.dataset);
    return;
  }

  // 2) Click en item de lista
  const item = e.target.closest('.cc-item');
  if (item){
    const entity = (item.dataset.entity || '').trim();
    const rawId = (item.dataset.id || '').trim();
    if (!entity || !rawId){
      toast('Error', 'Item sin ID', 'error');
      return;
    }
    const cleanId = rawId.split(/[\\s|]+/)[0] || rawId;
    e.preventDefault();

    console.log(`[DETAIL] entity=${entity} id=${cleanId}`);

    if (entity === 'proformas'){
      loadPresupuestoDetail(cleanId);
      return;
    }
    loadEntityDetail(entity, cleanId);
    return;
  }
});

/* =========================
   Search input (filtro)
========================= */
document.addEventListener('input', (e) => {
  if (e.target && e.target.id === 'q'){
    loadList(state.currentEntity);
  }
});

/* =========================
   INIT APP
========================= */
document.addEventListener('DOMContentLoaded', () => {
  updateMockChip_();
  initNav();
  initListTabs();
  loadMockPreference_()
    .then(() => {
      updateMockChip_();
      loadDashboard();
      loadList(state.currentEntity || 'clientes');
    })
    .catch(() => {
      loadDashboard();
      loadList(state.currentEntity || 'clientes');
    });

  // estado inicial
  showScreen('screen-home');
  setNavActive('home');
});
</script>

